<!DOCTYPE html>
<html lang="{{ shop.locale }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Check eSIM Status</title>
  
  <!-- jQuery LADEN - WICHTIG! -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  
<!-- templates/page.check-esim.liquid -->
<!-- SIMBYE CHECK ESIM - ENTERPRISE PRODUCTION VERSION FIXED -->

<!-- templates/page.check-esim.liquid -->
<!-- SIMBYE CHECK ESIM - CLEAN ENTERPRISE VERSION -->

<!-- templates/page.check-esim.liquid -->
<!-- SIMBYE CHECK ESIM - CLEAN ENTERPRISE VERSION -->

<style>
/* ================================================
   DESIGN SYSTEM - CLEAN & FOCUSED
   ================================================ */

:root {
  --primary: #009a61;
  --primary-dark: #00824f;
  --accent: #00d97e;
  --text: #1a1a1a;
  --text-secondary: #666666;
  --bg-page: linear-gradient(180deg, #ffffff 0%, #f8fffe 100%);
  --bg-card: #ffffff;
  --border: rgba(0, 0, 0, 0.06);
  --shadow: 0 12px 32px rgba(0, 154, 97, 0.15);
  --radius: 24px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

[data-theme="dark"] {
  --text: #f5f5f5;
  --text-secondary: #999999;
  --bg-page: #0a0a0a;
  --bg-card: #1a1a1a;
  --border: rgba(255, 255, 255, 0.08);
  --primary: #00d97e;
  --accent: #00ff88;
}

/* Kill Shopify Grid */
.shopify-section:has(.check-page) {
  display: block !important;
  padding: 0 !important;
  margin: 0 !important;
  grid-template-columns: unset !important;
}

/* Page Layout */
.check-page {
  min-height: 100vh;
  background: var(--bg-page);
  padding: 40px 20px;
}

.check-container {
  max-width: 600px;
  margin: 0 auto;
}

/* Search Card */
.search-card {
  background: var(--bg-card);
  border-radius: var(--radius);
  padding: 40px;
  box-shadow: var(--shadow);
  margin-bottom: 24px;
  text-align: center;
  transition: var(--transition);
}

.search-card.hidden {
  display: none;
}

.search-title {
  font-size: 28px;
  font-weight: 800;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 24px;
}

.search-form {
  display: flex;
  background: #f8f8f8;
  border-radius: 100px;
  padding: 4px;
  border: 2px solid transparent;
  transition: var(--transition);
}

[data-theme="dark"] .search-form {
  background: rgba(255, 255, 255, 0.05);
}

.search-form:focus-within {
  border-color: var(--primary);
}

.search-input {
  flex: 1;
  padding: 16px 24px;
  background: transparent;
  border: none;
  outline: none;
  font-size: 16px;
  color: var(--text);
}

.search-btn {
  padding: 14px 32px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
  border: none;
  border-radius: 100px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
}

.search-btn:hover:not(:disabled) {
  transform: scale(1.05);
  box-shadow: 0 8px 24px rgba(0, 154, 97, 0.3);
}

.search-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Message */
.message {
  margin-top: 16px;
  padding: 12px 20px;
  border-radius: 12px;
  font-size: 14px;
  display: none;
}

.message.show {
  display: block;
}

.message.error {
  background: #fee2e2;
  color: #dc2626;
}

.message.success {
  background: #d1fae5;
  color: #065f46;
}

/* Loading */
.loading {
  display: none;
  text-align: center;
  padding: 60px;
}

.loading.active {
  display: block;
}

.spinner {
  width: 48px;
  height: 48px;
  border: 3px solid rgba(0, 154, 97, 0.1);
  border-top-color: var(--primary);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 0 auto 16px;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Main eSIM Card */
.esim-card {
  display: none;
  background: var(--bg-card);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow);
  animation: fadeIn 0.5s ease;
}

.esim-card.active {
  display: block;
}

/* eSIM Header */
.esim-header {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
  padding: 32px;
  text-align: center;
}

.package-name {
  font-size: 24px;
  font-weight: 800;
  margin-bottom: 12px;
}

.status-badges {
  display: flex;
  justify-content: center;
  gap: 12px;
  flex-wrap: wrap;
}

.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 16px;
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  border-radius: 100px;
  font-size: 13px;
  font-weight: 600;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: currentColor;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Quick Info Grid */
.quick-info {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  padding: 24px;
  gap: 16px;
  background: linear-gradient(to bottom, transparent, rgba(0, 154, 97, 0.03));
}

.info-item {
  text-align: center;
}

.info-icon {
  width: 40px;
  height: 40px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 8px;
}

.info-icon svg {
  width: 20px;
  height: 20px;
  color: white;
}

.info-label {
  font-size: 11px;
  text-transform: uppercase;
  color: var(--text-secondary);
  letter-spacing: 0.5px;
  margin-bottom: 4px;
}

.info-value {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
}

/* QR Section */
.qr-section {
  padding: 32px;
  text-align: center;
  border-bottom: 1px solid var(--border);
  position: relative;
}

.qr-container {
  position: relative;
  display: inline-block;
}

.qr-code {
  width: 200px;
  height: 200px;
  border: 2px solid var(--border);
  border-radius: 20px;
  padding: 10px;
  background: white;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
}

.qr-blur {
  filter: blur(10px);
  pointer-events: none;
}

.verify-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  padding: 20px;
}

[data-theme="dark"] .verify-overlay {
  background: rgba(26, 26, 26, 0.95);
}

.verify-overlay.hidden {
  display: none;
}

.verify-icon {
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 12px;
}

.verify-icon svg {
  width: 24px;
  height: 24px;
  color: white;
}

.verify-text {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 16px;
}

.verify-btn {
  padding: 10px 24px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
  border: none;
  border-radius: 100px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
}

.verify-btn:hover {
  transform: scale(1.05);
}

.qr-actions {
  display: flex;
  gap: 12px;
  justify-content: center;
  margin-top: 20px;
}

.qr-action {
  padding: 10px 20px;
  background: var(--bg-card);
  border: 2px solid var(--border);
  border-radius: 12px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.qr-action:hover {
  border-color: var(--primary);
  background: rgba(0, 154, 97, 0.05);
}

.qr-action svg {
  width: 16px;
  height: 16px;
}

/* Usage Section */
.usage-section {
  padding: 32px;
  background: var(--bg-card);
  border-bottom: 1px solid var(--border);
}

.usage-title {
  font-size: 18px;
  font-weight: 700;
  text-align: center;
  margin-bottom: 24px;
  color: var(--text);
}

.usage-visual {
  max-width: 200px;
  margin: 0 auto 24px;
  position: relative;
}

.usage-ring {
  width: 100%;
  aspect-ratio: 1;
}

.ring-bg {
  fill: none;
  stroke: #e5e7eb;
  stroke-width: 12;
}

[data-theme="dark"] .ring-bg {
  stroke: rgba(255, 255, 255, 0.1);
}

.ring-progress {
  fill: none;
  stroke: url(#gradient);
  stroke-width: 12;
  stroke-linecap: round;
  transform: rotate(-90deg);
  transform-origin: center;
  transition: stroke-dashoffset 1s ease;
}

.usage-center {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
}

.usage-percent {
  font-size: 36px;
  font-weight: 800;
  color: var(--primary);
}

.usage-percent.low {
  color: #ef4444;
}

.usage-label {
  font-size: 12px;
  color: var(--text-secondary);
  text-transform: uppercase;
}

.usage-stats {
  display: flex;
  justify-content: space-around;
  padding: 20px;
  background: rgba(0, 154, 97, 0.05);
  border-radius: 16px;
}

.usage-stat {
  text-align: center;
}

.stat-value {
  font-size: 20px;
  font-weight: 700;
  color: var(--text);
  display: block;
}

.stat-label {
  font-size: 11px;
  color: var(--text-secondary);
  text-transform: uppercase;
  margin-top: 4px;
}

/* Details Section */
.details-section {
  padding: 32px;
  background: var(--bg-card);
}

.details-grid {
  display: grid;
  gap: 16px;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: rgba(0, 154, 97, 0.03);
  border-radius: 12px;
}

.detail-label {
  font-size: 13px;
  text-transform: uppercase;
  color: var(--text-secondary);
  letter-spacing: 0.5px;
}

.detail-value {
  font-size: 15px;
  font-weight: 600;
  color: var(--text);
  word-break: break-all;
}

/* Action Section */
.action-section {
  padding: 32px;
  text-align: center;
  background: linear-gradient(to bottom, rgba(0, 154, 97, 0.03), transparent);
}

.primary-btn {
  padding: 18px 48px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
  border: none;
  border-radius: 100px;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
  box-shadow: 0 10px 30px rgba(0, 154, 97, 0.3);
}

.primary-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 15px 40px rgba(0, 154, 97, 0.4);
}

.primary-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.action-info {
  margin-top: 12px;
  font-size: 13px;
  color: var(--text-secondary);
}

.action-info.warning {
  color: #f59e0b;
}

.action-info.error {
  color: #ef4444;
}

/* Modals */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(10px);
  z-index: 9999;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: var(--bg-card);
  padding: 40px;
  border-radius: var(--radius);
  max-width: 500px;
  width: 100%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  position: relative;
}

.modal-header {
  text-align: center;
  margin-bottom: 24px;
}

.modal-title {
  font-size: 24px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 8px;
}

.modal-subtitle {
  color: var(--text-secondary);
  font-size: 14px;
}

.modal-input {
  width: 100%;
  padding: 14px 20px;
  border: 2px solid var(--border);
  border-radius: 12px;
  font-size: 15px;
  margin-bottom: 20px;
  transition: var(--transition);
}

.modal-input:focus {
  outline: none;
  border-color: var(--primary);
}

.modal-actions {
  display: flex;
  gap: 12px;
}

.modal-btn {
  flex: 1;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.modal-btn.primary {
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
}

.modal-btn.secondary {
  background: #f3f4f6;
  color: var(--text-secondary);
}

/* Top-Up Modal */
.topup-content {
  max-height: 60vh;
  overflow-y: auto;
}

.topup-plans {
  display: grid;
  gap: 16px;
  margin-bottom: 20px;
}

.topup-plan {
  background: linear-gradient(135deg, rgba(0, 154, 97, 0.05), rgba(0, 217, 126, 0.05));
  border: 2px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  transition: var(--transition);
}

.topup-plan:hover {
  border-color: var(--primary);
  transform: scale(1.02);
}

.topup-name {
  font-size: 18px;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 8px;
}

.topup-price {
  font-size: 28px;
  font-weight: 800;
  color: var(--primary);
  margin-bottom: 12px;
}

.topup-buy {
  width: 100%;
  padding: 10px;
  background: linear-gradient(135deg, var(--primary), var(--accent));
  color: white;
  border: none;
  border-radius: 100px;
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  transition: var(--transition);
}

.topup-buy:hover {
  transform: scale(1.05);
}

.modal-close {
  position: absolute;
  top: 20px;
  right: 20px;
  width: 32px;
  height: 32px;
  background: rgba(0, 0, 0, 0.1);
  border: none;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: var(--transition);
}

.modal-close:hover {
  background: rgba(239, 68, 68, 0.1);
  transform: rotate(90deg);
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Mobile */
@media (max-width: 640px) {
  .check-page {
    padding: 20px 16px;
  }
  
  .search-card {
    padding: 32px 24px;
  }
  
  .search-title {
    font-size: 24px;
  }
  
  .search-form {
    flex-direction: column;
    gap: 8px;
  }
  
  .search-btn {
    width: 100%;
  }
  
  .quick-info {
    grid-template-columns: repeat(3, 1fr);
    padding: 20px;
    gap: 12px;
  }
  
  .info-value {
    font-size: 16px;
  }
  
  .qr-code {
    width: 180px;
    height: 180px;
  }
  
  .modal-content {
    padding: 32px 24px;
  }
}
</style>

<!-- HTML -->
<div class="check-page">
  <div class="check-container">
    
    <!-- Search Card -->
    <div class="search-card" id="searchCard">
      <h1 class="search-title">{{ 'check.title' | t | default: 'Check Your eSIM' }}</h1>
      
      <div class="search-form">
        <input 
          type="text" 
          id="orderInput" 
          class="search-input"
          placeholder="{{ 'check.placeholder' | t | default: 'Enter order number' }}"
        >
        <button id="searchBtn" class="search-btn">
          {{ 'check.search' | t | default: 'SEARCH' }}
        </button>
      </div>
      
      <div id="message" class="message"></div>
    </div>
    
    <!-- Loading -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>{{ 'check.loading' | t | default: 'Loading...' }}</p>
    </div>
    
    <!-- Main eSIM Card -->
    <div id="esimCard" class="esim-card">
      
      <!-- Header -->
      <div class="esim-header">
        <h2 class="package-name" id="packageName">-</h2>
        <div class="status-badges">
          <span class="status-badge">
            <span class="status-dot"></span>
            <span id="esimStatus">-</span>
          </span>
          <span class="status-badge" id="typeBadge">
            <span id="esimType">-</span>
          </span>
        </div>
      </div>
      
      <!-- Quick Info -->
      <div class="quick-info">
        <div class="info-item">
          <div class="info-icon">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
          </div>
          <div class="info-label">{{ 'check.total_data' | t | default: 'Total Data' }}</div>
          <div class="info-value" id="totalData">-</div>
        </div>
        
        <div class="info-item">
          <div class="info-icon">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
          <div class="info-label">{{ 'check.validity' | t | default: 'Validity' }}</div>
          <div class="info-value" id="validity">-</div>
        </div>
        
        <div class="info-item">
          <div class="info-icon">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
          </div>
          <div class="info-label">{{ 'check.expires' | t | default: 'Expires' }}</div>
          <div class="info-value" id="expiryDate">-</div>
        </div>
      </div>
      
      <!-- QR Section -->
      <div class="qr-section">
        <div class="qr-container">
          <img id="qrCode" class="qr-code qr-blur" src="" alt="QR Code">
          <div class="verify-overlay" id="verifyOverlay">
            <div class="verify-icon">
              <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
              </svg>
            </div>
            <p class="verify-text">{{ 'check.verify_text' | t | default: 'Verify email to view QR code' }}</p>
            <button class="verify-btn" id="verifyBtn">
              {{ 'check.verify_button' | t | default: 'VERIFY EMAIL' }}
            </button>
          </div>
        </div>
        <div class="qr-actions">
          <button class="qr-action" id="downloadBtn">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
            {{ 'check.download' | t | default: 'Download' }}
          </button>
          <button class="qr-action" id="manualBtn">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            {{ 'check.manual' | t | default: 'Manual' }}
          </button>
        </div>
      </div>
      
      <!-- Usage Section -->
      <div class="usage-section">
        <h3 class="usage-title">{{ 'check.data_usage' | t | default: 'Data Usage' }}</h3>
        
        <div class="usage-visual">
          <svg class="usage-ring" viewBox="0 0 120 120">
            <defs>
              <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#009a61" />
                <stop offset="100%" stop-color="#00d97e" />
              </linearGradient>
            </defs>
            <circle cx="60" cy="60" r="50" class="ring-bg" />
            <circle cx="60" cy="60" r="50" class="ring-progress" 
                    stroke-dasharray="314" 
                    stroke-dashoffset="314" 
                    id="progressRing" />
          </svg>
          <div class="usage-center">
            <div class="usage-percent" id="usagePercent">0%</div>
            <div class="usage-label">{{ 'check.remaining' | t | default: 'Remaining' }}</div>
          </div>
        </div>
        
        <div class="usage-stats">
          <div class="usage-stat">
            <span class="stat-value" id="dataUsed">-</span>
            <span class="stat-label">{{ 'check.consumed' | t | default: 'Consumed' }}</span>
          </div>
          <div class="usage-stat">
            <span class="stat-value" id="dataLeft">-</span>
            <span class="stat-label">{{ 'check.remaining' | t | default: 'Remaining' }}</span>
          </div>
        </div>
      </div>
      
      <!-- Details Section -->
      <div class="details-section">
        <div class="details-grid">
          <div class="detail-row">
            <span class="detail-label">{{ 'check.iccid' | t | default: 'ICCID' }}</span>
            <span class="detail-value" id="iccid">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">{{ 'check.apn' | t | default: 'APN' }}</span>
            <span class="detail-value" id="apn">-</span>
          </div>
        </div>
      </div>
      
      <!-- Action Section -->
      <div class="action-section">
        <button id="actionBtn" class="primary-btn">
          {{ 'check.topup' | t | default: 'TOP UP NOW' }}
        </button>
        <div id="actionInfo" class="action-info"></div>
      </div>
      
    </div>
    
  </div>
</div>

<!-- Email Modal -->
<div id="emailModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" id="closeEmail">✕</button>
    <div class="modal-header">
      <h3 class="modal-title">{{ 'check.email_title' | t | default: 'Email Verification' }}</h3>
      <p class="modal-subtitle">{{ 'check.email_subtitle' | t | default: 'Enter your email to view QR code' }}</p>
    </div>
    <input 
      type="email" 
      id="emailInput" 
      class="modal-input"
      placeholder="{{ 'check.email_placeholder' | t | default: 'your@email.com' }}"
    >
    <div class="modal-actions">
      <button class="modal-btn primary" id="verifyEmail">
        {{ 'check.verify' | t | default: 'Verify' }}
      </button>
      <button class="modal-btn secondary" id="cancelEmail">
        {{ 'check.cancel' | t | default: 'Cancel' }}
      </button>
    </div>
  </div>
</div>

<!-- Top-Up Modal -->
<div id="topupModal" class="modal">
  <div class="modal-content topup-content">
    <button class="modal-close" id="closeTopup">✕</button>
    <div class="modal-header">
      <h3 class="modal-title">{{ 'check.topup_title' | t | default: 'Select Top-Up Plan' }}</h3>
    </div>
    <div class="topup-plans" id="topupPlans">
      <!-- Plans will load here -->
    </div>
  </div>
</div>

<script>
// Check jQuery
if (typeof jQuery === 'undefined') {
  var script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js';
  document.head.appendChild(script);
  script.onload = initEsimCheck;
} else {
  jQuery(document).ready(initEsimCheck);
}

function initEsimCheck() {
  const $ = jQuery;
  
  // State
  let currentOrder = null;
  let currentEsim = null;
  let isEmailVerified = false;
  let attempts = 0;
  const maxAttempts = 3;
  const lockDuration = 60 * 60 * 1000; // 1 hour
  
  // Initialize
  init();
  
  function init() {
    // Check lockout
    checkLockout();
    
    // URL params
    const urlParams = new URLSearchParams(window.location.search);
    const orderParam = urlParams.get('order_number');
    if (orderParam) {
      $('#orderInput').val(orderParam);
      search();
    }
    
    // Events
    $('#searchBtn').click(search);
    $('#orderInput').keypress(e => { if (e.which === 13) search(); });
    $('#verifyBtn').click(() => $('#emailModal').addClass('active'));
    $('#verifyEmail').click(verifyEmail);
    $('#cancelEmail, #closeEmail').click(() => $('#emailModal').removeClass('active'));
    $('#actionBtn').click(handleAction);
    $('#downloadBtn').click(downloadQR);
    $('#manualBtn').click(showManual);
    $('#closeTopup').click(() => $('#topupModal').removeClass('active'));
  }
  
  // Check lockout
  function checkLockout() {
    const lockEnd = sessionStorage.getItem('lockEnd');
    if (lockEnd && Date.now() < parseInt(lockEnd)) {
      const mins = Math.ceil((parseInt(lockEnd) - Date.now()) / 60000);
      showMessage(`{{ 'check.locked' | t | default: 'Too many attempts. Try again in %mins% minutes' }}`.replace('%mins%', mins), 'error');
      $('#searchBtn').prop('disabled', true);
      return true;
    }
    $('#searchBtn').prop('disabled', false);
    return false;
  }
  
  // Search
  function search() {
    if (checkLockout()) return;
    
    const order = $('#orderInput').val().trim();
    if (!order) {
      showMessage('{{ 'check.enter_order' | t | default: 'Please enter order number' }}', 'error');
      return;
    }
    
    currentOrder = order;
    showLoading(true);
    hideMessage();
    
    $.ajax({
      url: 'https://simbye.com/apps/topup/info/' + order,
      method: 'GET',
      headers: { 'Accept': 'application/json' },
      timeout: 10000,
      success: response => {
        showLoading(false);
        if (response?.data?.obj?.esimList?.[0]) {
          currentEsim = response.data.obj.esimList[0];
          attempts = 0;
          displayEsim();
          $('#searchCard').slideUp();
        } else {
          handleFailedAttempt();
        }
      },
      error: () => {
        showLoading(false);
        handleFailedAttempt();
      }
    });
  }
  
  // Handle failed attempt
  function handleFailedAttempt() {
    attempts++;
    if (attempts >= maxAttempts) {
      sessionStorage.setItem('lockEnd', Date.now() + lockDuration);
      checkLockout();
    } else {
      showMessage(`{{ 'check.not_found' | t | default: 'Order not found. Attempt %attempt% of %max%' }}`
        .replace('%attempt%', attempts)
        .replace('%max%', maxAttempts), 'error');
    }
  }
  
  // Display eSIM
  function displayEsim() {
    const pkg = currentEsim.packageList?.[0] || {};
    
    // Show card
    $('#esimCard').addClass('active');
    
    // Package name
    $('#packageName').text(pkg.packageName || 'eSIM');
    
    // Status
    const status = getStatus();
    $('#esimStatus').text(status.label);
    
    // Type
    const type = getType();
    $('#esimType').text(type.label);
    
    // Data calculations
    const totalGB = (currentEsim.totalVolume / 1073741824).toFixed(2);
    const usedGB = (currentEsim.orderUsage / 1073741824).toFixed(2);
    const leftGB = Math.max(0, totalGB - usedGB).toFixed(2);
    const remainingPercent = Math.max(0, 100 - (currentEsim.orderUsage / currentEsim.totalVolume * 100));
    
    // Quick info
    $('#totalData').text(totalGB + ' GB');
    $('#validity').text((currentEsim.totalDuration || 0) + ' {{ 'check.days' | t | default: 'Days' }}');
    $('#expiryDate').text(formatDate(currentEsim.expiredTime));
    
    // Usage
    $('#usagePercent').text(Math.round(remainingPercent) + '%');
    if (remainingPercent < 20) $('#usagePercent').addClass('low');
    
    const circumference = 2 * Math.PI * 50;
    const offset = circumference - (remainingPercent / 100) * circumference;
    $('#progressRing').css('stroke-dashoffset', offset);
    
    $('#dataUsed').text(usedGB + ' GB');
    $('#dataLeft').text(leftGB + ' GB');
    
    // Details (without email)
    $('#iccid').text(formatIccid(currentEsim.iccid));
    $('#apn').text('-'); // Hidden until email verify
    
    // Action button
    updateAction(type);
    
    showMessage('{{ 'check.found' | t | default: 'eSIM found! Verify email for full details' }}', 'success');
  }
  
  // Get status
  function getStatus() {
    if (isExpired()) return { label: '{{ 'check.status_expired' | t | default: 'Expired' }}', color: 'red' };
    
    switch(currentEsim.esimStatus) {
      case 'IN_USE': return { label: '{{ 'check.status_active' | t | default: 'Active' }}', color: 'green' };
      case 'NEW': return { label: '{{ 'check.status_ready' | t | default: 'Ready' }}', color: 'yellow' };
      case 'ONBOARD': return { label: '{{ 'check.status_installed' | t | default: 'Already Installed' }}', color: 'green' };
      case 'GOT_RESOURCE': return { label: '{{ 'check.status_ready_install' | t | default: 'Ready to Install' }}', color: 'yellow' };
      case 'USEDUP': return { label: '{{ 'check.status_used' | t | default: 'Used Up' }}', color: 'red' };
      default: return { label: '{{ 'check.status_unknown' | t | default: 'Unknown' }}', color: 'gray' };
    }
  }
  
  // Get type
  function getType() {
    const pkg = currentEsim.packageList?.[0] || {};
    const slug = (pkg.slug || '').toLowerCase();
    const name = (pkg.packageName || '').toLowerCase();
    
    if (slug.includes('daily') || slug.includes('_daily')) {
      return { 
        type: 'DAILY',
        label: '{{ 'check.type_daily' | t | default: 'Daily Reset' }}',
        canTopUp: false
      };
    }
    
    if (name.includes('unlimited')) {
      return {
        type: 'UNLIMITED',
        label: '{{ 'check.type_unlimited' | t | default: 'Unlimited' }}',
        canTopUp: false
      };
    }
    
    if (isExpired()) {
      return {
        type: 'EXPIRED',
        label: '{{ 'check.type_expired' | t | default: 'Expired' }}',
        canTopUp: false
      };
    }
    
    return {
      type: 'NORMAL',
      label: '{{ 'check.type_standard' | t | default: 'Standard' }}',
      canTopUp: true
    };
  }
  
  // Update action button
  function updateAction(type) {
    const $btn = $('#actionBtn');
    const $info = $('#actionInfo');
    
    if (type.type === 'EXPIRED') {
      $btn.text('{{ 'check.buy_new' | t | default: 'BUY NEW ESIM' }}').prop('disabled', false);
      $info.text('{{ 'check.expired_info' | t | default: 'This eSIM has expired' }}').addClass('error');
      $btn.off('click').click(() => window.location.href = '/collections/all');
      
    } else if (type.type === 'DAILY' || type.type === 'UNLIMITED') {
      $btn.text('{{ 'check.not_rechargeable' | t | default: 'NOT RECHARGEABLE' }}').prop('disabled', true);
      $info.text('{{ 'check.daily_info' | t | default: 'Daily/Unlimited plans cannot be topped up' }}').addClass('warning');
      
    } else if (type.canTopUp) {
      $btn.text('{{ 'check.topup_now' | t | default: 'TOP UP NOW' }}').prop('disabled', false);
      $info.text('{{ 'check.topup_info' | t | default: 'Add more data anytime' }}').removeClass('warning error');
      $btn.off('click').click(handleAction);
    }
  }
  
  // Handle action
  function handleAction() {
    const type = getType();
    if (type.canTopUp) {
      // Direct to top-up WITHOUT email check
      loadTopUp();
    }
  }
  
  // Load top-up
  function loadTopUp() {
    if (!currentEsim) return;
    
    const pkg = currentEsim.packageList?.[0] || {};
    const currency = window.Shopify?.currency?.active || 'EUR';
    
    showLoading(true);
    
    $.ajax({
      url: `https://simbye.com/apps/topup/plans?esimTranNo=${currentEsim.esimTranNo}&packageCode=${pkg.packageCode}&currency=${currency}`,
      method: 'GET',
      headers: { 'Accept': 'application/json' },
      success: response => {
        showLoading(false);
        if (response?.data?.length > 0) {
          displayTopUp(response.data);
        } else {
          alert('{{ 'check.no_plans' | t | default: 'No top-up plans available' }}');
        }
      },
      error: () => {
        showLoading(false);
        alert('{{ 'check.load_failed' | t | default: 'Failed to load plans' }}');
      }
    });
  }
  
  // Display top-up plans
  function displayTopUp(plans) {
    let html = '';
    plans.forEach(plan => {
      html += `
        <div class="topup-plan">
          <div class="topup-name">${plan.name}</div>
          <div class="topup-price">${plan.price} ${window.Shopify?.currency?.active || 'EUR'}</div>
          <button class="topup-buy" data-variant="${plan.variant_id}" data-package="${plan.packageCode}">
            {{ 'check.buy' | t | default: 'BUY NOW' }}
          </button>
        </div>
      `;
    });
    
    $('#topupPlans').html(html);
    $('#topupModal').addClass('active');
    
    // Buy handlers
    $('.topup-buy').click(function() {
      buyTopUp($(this).data('variant'), $(this).data('package'));
    });
  }
  
  // Buy top-up
  function buyTopUp(variantId, packageCode) {
    $.post('/cart/add.js', {
      items: [{
        quantity: 1,
        id: variantId,
        properties: {
          'packageCode': packageCode,
          'esimTranNo': currentEsim.esimTranNo,
          'type': 'TOPUP'
        }
      }]
    })
    .done(() => window.location.href = '/checkout')
    .fail(() => alert('{{ 'check.cart_failed' | t | default: 'Failed to add to cart' }}'));
  }
  
  // Verify email
  function verifyEmail() {
    const email = $('#emailInput').val().trim();
    if (!email) {
      alert('{{ 'check.enter_email' | t | default: 'Please enter email' }}');
      return;
    }
    
    showLoading(true);
    
    $.ajax({
      url: `https://simbye.com/apps/topup/info/${currentOrder}/${email}`,
      method: 'GET',
      headers: { 'Accept': 'application/json' },
      success: response => {
        showLoading(false);
        if (response?.data?.obj?.esimList?.[0]) {
          currentEsim = response.data.obj.esimList[0];
          isEmailVerified = true;
          displayFullData();
          $('#emailModal').removeClass('active');
        } else {
          alert('{{ 'check.verify_failed' | t | default: 'Verification failed' }}');
        }
      },
      error: () => {
        showLoading(false);
        alert('{{ 'check.verify_failed' | t | default: 'Verification failed' }}');
      }
    });
  }
  
  // Display full data
  function displayFullData() {
    // WICHTIG: Zuerst eSIM neu anzeigen
    displayEsim();
    
    // Show QR
    if (currentEsim.qrCodeUrl) {
      $('#qrCode').attr('src', currentEsim.qrCodeUrl).removeClass('qr-blur');
      $('#verifyOverlay').addClass('hidden');
    }
    
    // Show APN
    $('#apn').text(currentEsim.apn || '-');
    
    showMessage('{{ 'check.verified' | t | default: 'Email verified successfully!' }}', 'success');
  }
  
  // Download QR
  function downloadQR() {
    const url = $('#qrCode').attr('src');
    if (url) {
      const a = document.createElement('a');
      a.href = url;
      a.download = 'esim-qr.png';
      a.click();
    }
  }
  
  // Show manual
  function showManual() {
    if (currentEsim?.ac) {
      alert(`{{ 'check.manual_guide' | t | default: 'Manual Installation:\n1. Go to Settings > Cellular\n2. Add Cellular Plan\n3. Enter manually\n4. SM-DP+: %code%' }}`.replace('%code%', currentEsim.ac));
    } else {
      alert('{{ 'check.manual_unavailable' | t | default: 'Please verify email first' }}');
    }
  }
  
  // Helpers
  function isExpired() {
    return new Date(currentEsim.expiredTime) < new Date();
  }
  
  function formatDate(str) {
    if (!str) return '-';
    return new Date(str).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
  }
  
  function formatIccid(str) {
    if (!str) return '-';
    return str.replace(/(.{4})/g, '$1 ').trim();
  }
  
  function showMessage(msg, type) {
    $('#message').text(msg).removeClass().addClass('message ' + type + ' show');
  }
  
  function hideMessage() {
    $('#message').removeClass('show');
  }
  
  function showLoading(show) {
    if (show) {
      $('#loading').addClass('active');
      $('#esimCard').removeClass('active');
    } else {
      $('#loading').removeClass('active');
    }
  }
}
</script>