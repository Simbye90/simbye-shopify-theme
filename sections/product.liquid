<!-- sections/product.liquid -->
<!-- SIMBYE ENTERPRISE PRODUCT PAGE – FREE (0€) ENFORCEMENT + LOGIN REDIRECT + TITLE FIX + MOBILE STICKY FIX -->

<style>
.enterprise-header.scrolled,
.mobile-toggle. { display: none; } 

  /* RESET SHOPIFY GRID */
  .shopify-section:has(.product-enterprise) {
    display:block !important; padding:0 !important; margin:0 !important;
    grid-template-columns:unset !important; max-width:100% !important; width:100% !important;
  }
  .shopify-section:has(.product-enterprise) > * { grid-column:unset !important; margin:0 !important; }

  .product-enterprise { width:100vw !important; margin:0 !important; padding:0 !important; position:relative !important; left:0 !important; right:0 !important; }

  /* Vars */
  :root{
    --product-primary:#009a61;
    --product-primary-dark:#00824f;
    --product-accent:#00d97e;
    --product-text:#1a1a1a;
    --product-text-secondary:#666666;
    --product-bg:#ffffff;
    --product-card-bg:#ffffff;
    --product-border:rgba(0,0,0,0.08);
    --product-shadow-sm:0 4px 12px rgba(0,0,0,0.06);
    --product-shadow-md:0 8px 24px rgba(0,0,0,0.08);
    --product-shadow-lg:0 12px 32px rgba(0,154,97,0.15);
    --product-gradient:linear-gradient(135deg,#f8fffe 0%,#ffffff 100%);
    --product-radius:24px;
    --product-radius-sm:16px;
    --product-transition:all .3s cubic-bezier(.4,0,.2,1);
  }
  [data-theme="dark"]{
    --product-text:#f5f5f5;
    --product-text-secondary:#999;
    --product-bg:#0a0a0a;
    --product-card-bg:rgba(26,26,26,.8);
    --product-border:rgba(255,255,255,.08);
    --product-primary:#00d97e;
    --product-primary-dark:#009a61;
    --product-accent:#00ff88;
    --product-shadow-sm:0 4px 12px rgba(0,0,0,.3);
    --product-shadow-md:0 8px 24px rgba(0,0,0,.4);
    --product-shadow-lg:0 12px 32px rgba(0,217,126,.15);
    --product-gradient:linear-gradient(135deg,rgba(0,217,126,.05) 0%,transparent 100%);
  }

  /* Main */
  .product-enterprise{ background:var(--product-bg); overflow:hidden; padding-top:20px !important; min-height:100vh; position:relative; transition:var(--product-transition); }
  .product-enterprise::before{ content:''; position:absolute; inset:0; pointer-events:none; z-index:0; }
  [data-theme="dark"] .product-enterprise{ background:#0a0a0a; }

  /* Hero */
  .product-hero{ max-width:1600px; margin:0 auto; padding:0 40px 80px; width:100%; position:relative; z-index:1; }
  .hero-container{ display:grid; grid-template-columns:580px 1fr; gap:80px; align-items:center; }
  .hero-image-section{ position:relative; animation:fadeInUp .8s ease; }
  .hero-image-wrapper{ position:relative; border-radius:var(--product-radius); overflow:hidden; box-shadow:var(--product-shadow-lg); aspect-ratio:4/3; background:var(--product-card-bg); border:2px solid var(--product-border); transition:var(--product-transition); }
  [data-theme="dark"] .hero-image-wrapper{ background:var(--product-card-bg); border-color:rgba(255,255,255,.08); backdrop-filter:blur(10px); }
  .hero-image{ width:100%; height:100%; object-fit:cover; }

  .hero-info-section{ animation:fadeInUp .8s ease .2s both; }
  .product-title-wrapper{ display:flex; align-items:center; gap:16px; margin-bottom:32px; animation:fadeInUp .8s ease .3s both; }
  .product-flag{ width:56px; height:42px; border-radius:12px; object-fit:cover; box-shadow:var(--product-shadow-md); border:2px solid var(--product-border); transition:var(--product-transition); }
  .product-title{ font-size:56px; font-weight:800; line-height:1.1; margin:0; letter-spacing:-.02em; color:var(--product-text); }

  /* Country name color rules (Light vs Dark) */
  .country-name{ color:#009a61; background:none; -webkit-background-clip:initial; -webkit-text-fill-color:initial; background-clip:initial; }
  [data-theme="dark"] .country-name{
    color:var(--product-primary); /* fallback */
    background:linear-gradient(135deg,var(--product-primary),var(--product-accent));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text;
  }
  .esim-text{ color:var(--product-text); }
  [data-theme="dark"] .esim-text{ color:#ffffff; }

  .hero-subtitle{ font-size:18px; color:var(--product-text-secondary); line-height:1.6; margin-bottom:32px; animation:fadeInUp .8s ease .4s both; }

  .hero-features{ display:flex; flex-direction:column; gap:20px; margin-bottom:32px; }
  .hero-feature{ display:flex; align-items:center; gap:16px; font-size:16px; color:var(--product-text); animation:fadeInUp .8s ease both; animation-delay:calc(.5s + var(--feature-index)*.1s); }
  .hero-feature:nth-child(1){ --feature-index:0; } .hero-feature:nth-child(2){ --feature-index:1; } .hero-feature:nth-child(3){ --feature-index:2; }
  .hero-feature-icon{ width:48px; height:48px; background:linear-gradient(135deg,var(--product-primary),var(--product-accent)); border-radius:14px; display:flex; align-items:center; justify-content:center; position:relative; box-shadow:0 8px 20px rgba(0,154,97,.25); animation:subtlePulse 4s ease-in-out infinite; flex-shrink:0; }
  .hero-feature-icon::before{ content:''; position:absolute; inset:-2px; border-radius:14px; opacity:0; z-index:-1; filter:blur(20px); animation:glow 4s ease-in-out infinite; }
  [data-theme="dark"] .hero-feature-icon{ background:linear-gradient(135deg,rgba(0,217,126,.2),rgba(0,154,97,.2)); box-shadow:0 8px 20px rgba(0,217,126,.2), inset 0 1px 2px rgba(255,255,255,.1); }
  .hero-feature-icon svg{ width:24px; height:24px; color:#fff; stroke-width:1.8; filter:drop-shadow(0 2px 4px rgba(0,0,0,.1)); }
  [data-theme="dark"] .hero-feature-icon svg{ color:var(--product-primary); }

  .trust-badges{ display:flex; gap:20px; padding-top:24px; border-top:1px solid var(--product-border); animation:fadeInUp .8s ease .7s both; }
  .trust-badge{ display:flex; align-items:center; gap:12px; color:var(--product-text-secondary); font-size:14px; transition:var(--product-transition); }
  .trust-badge:hover{ transform:translateX(4px); color:var(--product-text); }
  .trust-badge svg{ width:20px; height:20px; color:var(--product-primary); }

  /* Selection */
  .product-selection{ max-width:1600px; margin:0 auto; padding:0 40px 80px; width:100%; position:relative; z-index:1; }

  .variant-tabs{ display:flex; gap:4px; background:rgba(0,154,97,.05); padding:4px; border-radius:var(--product-radius-sm); border:1px solid rgba(0,154,97,.1); margin-bottom:32px; box-shadow:var(--product-shadow-sm); animation:fadeInUp .9s ease both; }
  [data-theme="dark"] .variant-tabs{ background:rgba(0,217,126,.05); border-color:rgba(0,217,126,.1); }
  .variant-tab{ flex:1; padding:16px 32px; background:transparent; border:none; border-radius:12px; font-size:18px; font-weight:600; color:var(--product-text-secondary); cursor:pointer; transition:var(--product-transition); display:flex; align-items:center; justify-content:center; gap:12px; font-family:inherit; }
  .variant-tab:hover{ background:rgba(0,154,97,.08); color:var(--product-text); }
  [data-theme="dark"] .variant-tab:hover{ background:rgba(0,217,126,.08); color:#fff; }
  .variant-tab.active{ background:var(--product-primary); color:#fff; box-shadow:0 4px 12px rgba(0,154,97,.3); }
  .tab-icon{ width:20px; height:20px; }

  .fair-use-notice{ background:var(--product-card-bg); border:2px solid var(--product-border); border-radius:var(--product-radius); padding:32px; margin-bottom:32px; display:none; animation:fadeInUp .4s ease; box-shadow:var(--product-shadow-md); position:relative; overflow:hidden; }
  [data-theme="dark"] .fair-use-notice{ background:var(--product-card-bg); border-color:rgba(255,255,255,.08); backdrop-filter:blur(10px); }
  .fair-use-notice.active{ display:block; }
  .fair-use-notice::before{ content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(0,154,97,.05) 0%,rgba(0,217,126,.05) 100%); pointer-events:none; }
  .fair-use-header{ display:flex; align-items:center; gap:12px; margin-bottom:12px; position:relative; }
  .fair-use-title{ font-size:18px; font-weight:700; color:var(--product-primary); margin:0; }
  .fair-use-text{ font-size:15px; color:var(--product-text-secondary); line-height:1.6; margin:0; position:relative; }

  .selection-grid{ display:grid; grid-template-columns:1.5fr 1fr; gap:40px; }
  .plans-container{ display:flex; flex-direction:column; }
  .variant-group{ display:flex; flex-direction:column; }

  .plan-card{
    position:relative; background:var(--product-card-bg); border:2px solid var(--product-border); border-radius:var(--product-radius);
    padding:36px 28px; cursor:pointer; transition:var(--product-transition); overflow:visible; margin-bottom:24px !important; box-shadow:var(--product-shadow-md);
    animation:fadeInUp .9s ease both;
  }
  .plan-card:nth-child(1){animation-delay:.1s;} .plan-card:nth-child(2){animation-delay:.2s;} .plan-card:nth-child(3){animation-delay:.3s;}
  .plan-card:nth-child(4){animation-delay:.4s;} .plan-card:nth-child(5){animation-delay:.5s;} .plan-card:nth-child(6){animation-delay:.6s;}
  [data-theme="dark"] .plan-card{ background:var(--product-card-bg); border-color:rgba(255,255,255,.08); backdrop-filter:blur(10px); }
  .plan-card:last-child{ margin-bottom:0 !important; }
  .plan-card:hover{ border-color:var(--product-primary); transform:translateY(-2px); box-shadow:var(--product-shadow-lg); }
  .plan-card.selected{ border-color:var(--product-primary); border-width:2px; background:var(--product-card-bg); box-shadow:var(--product-shadow-lg); position:relative; }
  .plan-card.selected::before{ content:''; position:absolute; inset:0; background:linear-gradient(135deg,rgba(0,154,97,.03) 0%,rgba(0,217,126,.03) 100%); border-radius:var(--product-radius); pointer-events:none; }
  .plan-content{ display:flex; justify-content:space-between; align-items:center; position:relative; z-index:1; }
  .plan-info{ flex:1; }
  .plan-name{ font-size:24px; font-weight:700; color:var(--product-text); margin-bottom:8px; letter-spacing:-.01em; line-height:1.2; }
  .plan-validity{ font-size:15px; color:var(--product-text-secondary); line-height:1.6; }
  .plan-price-wrapper{ text-align:right; }
  .plan-price-old{ display:block; font-size:16px; color:var(--product-text-secondary); text-decoration:line-through; margin-bottom:4px; opacity:.7; }
  .plan-price{ font-size:32px; font-weight:800; color:var(--product-primary); letter-spacing:-.02em; line-height:1; }

  .free-badge{
    position:absolute; top:-12px; left:20px; background:linear-gradient(135deg,var(--product-accent),#00ff88);
    color:#0a0a0a; padding:6px 16px; border-radius:100px; font-weight:700; font-size:12px; text-transform:uppercase;
    box-shadow:0 6px 20px rgba(0,217,126,.4); z-index:2; animation:subtlePulse 4s ease-in-out infinite;
  }
  .free-login-button{
    display:inline-flex; align-items:center; justify-content:center; padding:12px 24px;
    background:linear-gradient(135deg,var(--product-primary),var(--product-accent)); color:#fff; border:none; border-radius:100px;
    font-weight:700; font-size:15px; text-align:center; text-decoration:none; transition:var(--product-transition);
    white-space:nowrap; box-shadow:0 8px 24px rgba(0,154,97,.25); animation:subtlePulse 4s ease-in-out infinite;
  }
  .free-login-button:hover{ transform:translateY(-2px); box-shadow:var(--product-shadow-lg); }
  .popular-badge{
    position:absolute; top:-12px; right:20px; background:linear-gradient(135deg,#ff7e50,#ff9a76);
    color:#fff; padding:6px 16px; border-radius:100px; font-size:12px; font-weight:700; text-transform:uppercase; box-shadow:0 6px 20px rgba(255,126,80,.4); z-index:2; animation:subtlePulse 4s ease-in-out infinite;
  }

  /* Purchase */
  .purchase-box{ position:sticky; top:120px; background:var(--product-card-bg); border:2px solid var(--product-border); border-radius:var(--product-radius); padding:36px 32px; box-shadow:var(--product-shadow-lg); animation:fadeInUp .9s ease .7s both; }
  [data-theme="dark"] .purchase-box{ background:var(--product-card-bg); border-color:rgba(255,255,255,.08); backdrop-filter:blur(10px); }
  .purchase-title{ font-size:24px; font-weight:700; color:var(--product-text); margin-bottom:24px; letter-spacing:-.01em; }
  .summary-box{ background:var(--product-gradient); border-radius:16px; padding:24px; margin-bottom:24px; border:1px solid var(--product-border); }
  .summary-row{ display:flex; justify-content:space-between; align-items:center; padding:10px 0; }
  .summary-row:not(:last-child){ border-bottom:1px solid var(--product-border); }
  .summary-label{ font-size:15px; color:var(--product-text-secondary); }
  .summary-value{ font-size:16px; font-weight:600; color:var(--product-text); }
  .summary-row:last-child .summary-label, .summary-row:last-child .summary-value{ font-size:18px; font-weight:700; color:var(--product-primary); }

  .checkout-button{
    width:100%; background:linear-gradient(135deg,var(--product-primary),var(--product-accent)); color:#fff; border:none; border-radius:100px;
    padding:20px; font-size:18px; font-weight:700; cursor:pointer; transition:var(--product-transition);
    box-shadow:0 10px 30px rgba(0,154,97,.3); display:flex; align-items:center; justify-content:center; gap:12px; margin-bottom:24px; position:relative; animation:subtlePulse 4s ease-in-out infinite; z-index:2;
  }
  .checkout-button:hover:not(:disabled){ transform:translateY(-3px) scale(1.02); box-shadow:var(--product-shadow-lg); }
  .checkout-button:active:not(:disabled){ transform:scale(.98); }
  .payment-methods{ display:flex; justify-content:center; gap:12px; padding-top:24px; border-top:1px solid var(--product-border); }
  .payment-method{ height:24px; opacity:.7; transition:var(--product-transition); }
  .payment-method:hover{ opacity:1; transform:scale(1.1); }

  /* Animations */
  @keyframes fadeInUp{ from{opacity:0; transform:translateY(30px);} to{opacity:1; transform:translateY(0);} }
  @keyframes subtlePulse{ 0%,100%{ transform:translateY(0) scale(1);} 50%{ transform:translateY(-3px) scale(1.02);} }
  @keyframes glow{ 0%,100%{opacity:0;} 50%{opacity:.6;} }

  /* MOBILE */
  .sticky-cart{ display:none; }
  @media screen and (max-width:768px){
    .product-enterprise{ padding-top:0 !important; }
    .product-hero{ padding:0 !important; max-width:100% !important; position:relative; margin-bottom:32px; }
    .product-hero::before{
      content:''; position:absolute; top:0; left:0; right:0; height:80px;
      background:linear-gradient(to bottom, var(--bg-header) 0%, rgba(255,255,255,.9) 50%, transparent 100%); z-index:3; pointer-events:none;
    }
    [data-theme="dark"] .product-hero::before{ background:linear-gradient(to bottom,#0a0a0a 0%, rgba(10,10,10,.9) 50%, transparent 100%); }

    .hero-container{ grid-template-columns:1fr; gap:0; position:relative; }
    .hero-image-section{ position:absolute; inset:0; width:100vw !important; height:100%; z-index:1; }
    .hero-image-wrapper{ border-radius:0 !important; border:none !important; width:100vw !important; height:100%; margin:0 !important; box-shadow:none !important; animation:none; }
    .hero-image-wrapper::after{
      content:''; position:absolute; inset:0; background:linear-gradient(to bottom, rgba(255,255,255,.5) 0%, rgba(255,255,255,.75) 50%, rgba(255,255,255,.92) 100%); z-index:1;
    }
    [data-theme="dark"] .hero-image-wrapper::after{ background:linear-gradient(to bottom, rgba(10,10,10,.75) 0%, rgba(10,10,10,.88) 50%, rgba(10,10,10,.96) 100%); }
    .hero-image{ width:100%; height:100%; object-fit:cover; opacity:1; }

    .hero-info-section{ position:relative; z-index:4; padding:60px 20px 40px !important; text-align:left; }
    .product-title-wrapper{ justify-content:flex-start; margin-bottom:20px; align-items:flex-start; gap:12px; }
    .product-flag{ width:48px; height:48px; border-radius:50%; object-fit:cover; box-shadow:0 4px 12px rgba(0,0,0,.15); border:2px solid #fff; }
    [data-theme="dark"] .product-flag{ border-color:rgba(255,255,255,.1); }
    .product-title{ font-size:32px; line-height:1.2; }
    .hero-subtitle{ font-size:15px; margin-bottom:20px; line-height:1.5; }
    .hero-features{ gap:16px; } .hero-feature{ font-size:14px; }
    .hero-feature-icon{ width:40px; height:40px; border-radius:12px; } .hero-feature-icon svg{ width:20px; height:20px; }
    .trust-badges{ display:none !important; }

    .product-selection{ padding:0 20px 60px !important; }
    .selection-grid{ grid-template-columns:1fr; gap:24px; }
    .purchase-box{ display:none !important; }
    .variant-tabs{ margin-bottom:20px; } .variant-tab{ padding:12px 16px; font-size:15px; } .tab-icon{ width:18px; height:18px; }
    .plan-card{ margin-bottom:16px !important; padding:24px 20px; border-radius:20px; }
    .plan-card:last-child{ margin-bottom:0 !important; }
    .plan-name{ font-size:19px; } .plan-price{ font-size:26px; } .plan-price-old{ font-size:14px; }

    /* Sticky cart */
    .sticky-cart{
      display:block; position:fixed; bottom:0; left:0; width:100%; background:var(--product-card-bg);
      box-shadow:0 -2px 10px rgba(0,0,0,.15); z-index:999; padding:10px 16px; transform:translateY(100%); transition:transform .3s ease; border-top:1px solid var(--product-border);
    }
    [data-theme="dark"] .sticky-cart{ background:#1a1a1a; box-shadow:0 -2px 10px rgba(0,0,0,.3); }
    .sticky-cart.active{ transform:translateY(0); }
    .sticky-cart-header{ display:flex; align-items:center; justify-content:center; position:relative; padding:5px 0; }
    .sticky-cart-menu{ position:absolute; right:0; top:50%; transform:translateY(-50%); }
    .sticky-cart-menu a{ display:inline-flex; align-items:center; justify-content:center; text-decoration:none; cursor:pointer; color:var(--product-text); }
    .sticky-cart-title{ font-size:16px; font-weight:bold; color:var(--product-text); }
    .sticky-cart-button{
      display:flex; justify-content:center; align-items:center; width:100%; background:linear-gradient(135deg,var(--product-primary),var(--product-accent));
      border-radius:100px; text-decoration:none; padding:17px 24px; color:#fff; font-weight:bold; font-size:16px; gap:10px; margin-top:10px; border:none; cursor:pointer; box-shadow:0 8px 24px rgba(0,154,97,.25);
    }
    .sticky-cart-button:active{ transform:scale(.98); }
  }

  /* Safety */
  .sticky-cart, .sticky-cart *{ pointer-events:auto; }
  .checkout-button{ position:relative; z-index:2; }

  @media (prefers-reduced-motion:reduce){
    *{ animation-duration:.01ms !important; animation-iteration-count:1 !important; transition-duration:.01ms !important; }
  }
</style>

{%- comment -%} ---------- LOGIN RETURN URL (RELATIVE) + claim=free ---------- {%- endcomment -%}
{% capture _current_rel %}{{ request.path }}{% if request.query_string != blank %}?{{ request.query_string }}{% endif %}{% endcapture %}
{% assign _current_rel = _current_rel | strip %}
{% if request.query_string != blank %}
  {% assign _sep = '&' %}
{% else %}
  {% assign _sep = '?' %}
{% endif %}
{% capture _return_after_login %}{{ _current_rel }}{{ _sep }}claim=free{% endcapture %}
{% assign _encoded_return_after_login = _return_after_login | url_encode %}
{% assign login_free_url = routes.account_login_url | append: '?return_url=' | append: _encoded_return_after_login %}

{%- comment -%} ---------- PRECOMPUTE FREE VARIANTS & BLOCK STATE ---------- {%- endcomment -%}
{% assign free_variant_ids = '' %}
{% for v in product.variants %}
  {% if v.price == 0 %}
    {% assign free_variant_ids = free_variant_ids | append: v.id | append: ',' %}
  {% endif %}
{% endfor %}

{% assign free_blocked = false %}
{% if customer %}
  {% if customer.tags contains 'free_0_redeemed' %}
    {% assign free_blocked = true %}
  {% endif %}
  {% if free_blocked == false and customer.orders_count > 0 %}
    {% for order in customer.orders limit: 50 %}
      {% for line in order.line_items %}
        {% if free_variant_ids contains line.variant_id %}
          {% assign free_blocked = true %}
        {% endif %}
      {% endfor %}
      {% if free_blocked %}{% break %}{% endif %}
    {% endfor %}
  {% endif %}
{% endif %}

<section class="product-enterprise" data-product-id="{{ product.id }}">

  <!-- Hero -->
  <div class="product-hero">
    <div class="hero-container">

      <!-- Image -->
      <div class="hero-image-section">
        <div class="hero-image-wrapper">
          {% if product.images[1] %}
            {{ product.images[1] | image_url: width: 800 | image_tag: class:'hero-image', loading:'eager', fetchpriority:'high', alt:product.title }}
          {% else %}
            {{ product.featured_image | image_url: width: 800 | image_tag: class:'hero-image', loading:'eager', fetchpriority:'high', alt:product.title }}
          {% endif %}
        </div>
      </div>

      <!-- Info -->
      <div class="hero-info-section">
        <div class="product-title-wrapper">
          {% if product.featured_image %}
            {{ product.featured_image | image_url: width: 80 | image_tag: class:'product-flag', alt:product.title }}
          {% else %}
            {% assign country_code = product.handle | split: '-' | first %}
            <img src="https://flagcdn.com/w80/{{ country_code }}.png" class="product-flag" alt="{{ product.title }} flag" onerror="this.style.display='none'">
          {% endif %}

          <!-- FULL country name + "eSIM" (no splitting) -->
          <h1 class="product-title">
            <span class="country-name">{{ product.title }}</span>
            <span class="esim-text">eSIM</span>
          </h1>
        </div>

        <p class="hero-subtitle">
          {{ 'product.hero_subtitle' | t: country: product.title | default: 'Prepaid eSIM data plans. Activated in 60 seconds, keep your WhatsApp number, no contract.' }}
        </p>

        <div class="hero-features">
          <div class="hero-feature">
            <div class="hero-feature-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            </div>
            <span>{{ 'product.instant_delivery' | t | default: 'Instant delivery' }}</span>
          </div>
          <div class="hero-feature">
            <div class="hero-feature-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z"/></svg>
            </div>
            <span>{{ 'product.premium_network' | t | default: 'Premium 4G/5G network' }}</span>
          </div>
          <div class="hero-feature">
            <div class="hero-feature-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z"/></svg>
            </div>
            <span>{{ 'product.whatsapp_support' | t | default: '24/7 WhatsApp support' }}</span>
          </div>
        </div>

        <div class="trust-badges">
          <div class="trust-badge">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z"/></svg>
            <span>{{ 'product.money_back' | t | default: 'Money-back guarantee' }}</span>
          </div>
          <div class="trust-badge">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z"/></svg>
            <span>{{ 'product.secure_payment' | t | default: 'Secure payment' }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Product Selection -->
  <div class="product-selection">

    {% assign has_unlimited = false %}
    {% for variant in product.variants %}
      {% if variant.sku contains 'daily' or variant.sku contains 'Daily' or variant.sku contains 'unlimited' %}
        {% assign has_unlimited = true %}
      {% endif %}
    {% endfor %}

    {% if has_unlimited %}
      <div class="variant-tabs">
        <button class="variant-tab active" data-tab="normal">
          <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75"/></svg>
          <span>{{ 'product.data_plans' | t | default: 'Data Plans' }}</span>
        </button>
        <button class="variant-tab" data-tab="unlimited">
          <svg class="tab-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9.5 12c0 1.657-1.343 3-3 3s-3-1.343-3-3 1.343-3 3-3 3 1.343 3 3zM14.5 12c0-1.657 1.343-3 3-3s3 1.343 3 3-1.343 3-3 3-3-1.343-3-3z"/><path d="M9.5 12h5"/></svg>
          <span>{{ 'product.unlimited_daily' | t | default: 'Unlimited Daily' }}</span>
        </button>
      </div>

      <div class="fair-use-notice" id="fair-use-notice">
        <div class="fair-use-header">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"/></svg>
          <h3 class="fair-use-title">{{ 'product.fair_use_title' | t | default: 'Fair Use Policy' }}</h3>
        </div>
        <p class="fair-use-text">{{ 'product.fair_use_text' | t | default: '1GB daily at high speed. After 1GB, speed reduced to 128kbps. Data resets daily at midnight.' }}</p>
      </div>
    {% endif %}

    <div class="selection-grid">
      <div class="plans-container">

        <!-- Normal Variants -->
        <div class="variant-group" id="normal-variants" style="display:block;">
          {% assign variant_index = 0 %}
          {% for variant in product.variants %}
            {% unless variant.sku contains 'daily' or variant.sku contains 'Daily' or variant.sku contains 'unlimited' %}
              {% assign variant_index = variant_index | plus: 1 %}
              {% assign is_free = false %}
              {% if variant.price == 0 %}{% assign is_free = true %}{% endif %}

              {% unless is_free and free_blocked %}
              <div class="plan-card {% if variant_index == 1 and is_free == false %}selected{% endif %}"
                   data-variant-id="{{ variant.id }}"
                   data-is-free="{{ is_free }}">

                {% if is_free %}<span class="free-badge">FREE</span>{% endif %}
                {% if variant_index == 3 and is_free == false %}<span class="popular-badge">{{ 'product.popular' | t | default: 'POPULAR' }}</span>{% endif %}

                <input type="radio"
                       name="variant"
                       value="{{ variant.id }}"
                       data-price="{% if is_free %}FREE{% else %}{{ variant.price | money }}{% endif %}"
                       data-title="{% if is_free %}100MB Free eSIM{% else %}{{ variant.title }}{% endif %}"
                       {% if variant_index == 1 and is_free == false %}checked{% endif %}
                       style="display:none;">

                <div class="plan-content">
                  <div class="plan-info">
                    <div class="plan-name">{% if is_free %}100MB Free eSIM{% else %}{{ variant.title }}{% endif %}</div>
                    <div class="plan-validity">
                      {% if is_free %}
                        {{ 'product.valid_for' | t | default: 'Valid for' }} 7 {{ 'product.days' | t | default: 'days' }}
                      {% else %}
                        {{ 'product.valid_for' | t | default: 'Valid for' }}
                        {% assign title_parts = variant.title | split: " " %}
                        {% assign days_index = title_parts.size | minus: 2 %}
                        {{ title_parts[days_index] }} {{ 'product.days' | t | default: 'days' }}
                      {% endif %}
                    </div>
                  </div>
                  <div class="plan-price-wrapper">
                    {% if section.settings.show_compare_price and is_free == false %}
                      {% if variant.compare_at_price and variant.compare_at_price > variant.price %}
                        <span class="plan-price-old">{{ variant.compare_at_price | money }}</span>
                      {% elsif section.settings.price_increase_percent > 0 %}
                        {% assign multiplier = section.settings.price_increase_percent | plus: 100 | times: 1.0 | divided_by: 100 %}
                        {% assign old_price = variant.price | times: multiplier %}
                        <span class="plan-price-old">{{ old_price | money }}</span>
                      {% endif %}
                    {% endif %}

                    {% if is_free %}
                      {% if customer %}
                        <span class="plan-price">{{ 0 | money }}</span>
                      {% else %}
                   <a href="/account/login" class="free-login-button">
  {{ 'product.login_for_free' | t | default: 'Login for FREE' }}
</a>

                      {% endif %}
                    {% else %}
                      <span class="plan-price">{{ variant.price | money }}</span>
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endunless %}
            {% endunless %}
          {% endfor %}
        </div>

        {% if has_unlimited %}
          <div class="variant-group" id="unlimited-variants" style="display:none;">
            {% for variant in product.variants %}
              {% if variant.sku contains 'daily' or variant.sku contains 'Daily' or variant.sku contains 'unlimited' %}
                <div class="plan-card" data-variant-id="{{ variant.id }}" data-is-free="false">
                  <input type="radio" name="variant" value="{{ variant.id }}" data-price="{{ variant.price | money }}" data-title="{{ variant.title }}" style="display:none;">
                  <div class="plan-content">
                    <div class="plan-info">
                      <div class="plan-name">{{ variant.title }}</div>
                      <div class="plan-validity">{{ 'product.gb_per_day_for' | t: days: variant.title | default: '1GB/day' }}</div>
                    </div>
                    <div class="plan-price-wrapper">
                      {% if section.settings.show_compare_price %}
                        {% if variant.compare_at_price and variant.compare_at_price > variant.price %}
                          <span class="plan-price-old">{{ variant.compare_at_price | money }}</span>
                        {% elsif section.settings.price_increase_percent > 0 %}
                          {% assign multiplier = section.settings.price_increase_percent | plus: 100 | times: 1.0 | divided_by: 100 %}
                          {% assign old_price = variant.price | times: multiplier %}
                          <span class="plan-price-old">{{ old_price | money }}</span>
                        {% endif %}
                      {% endif %}
                      <span class="plan-price">{{ variant.price | money }}</span>
                    </div>
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- Purchase Box -->
      <div class="purchase-box">
        <h3 class="purchase-title">{{ 'product.your_selection' | t | default: 'Your Selection' }}</h3>

        <div class="summary-box">
          <div class="summary-row"><span class="summary-label">{{ product.title }} eSIM</span><span class="summary-value" id="selected-variant">-</span></div>
          <div class="summary-row"><span class="summary-label">{{ 'product.network' | t | default: 'Network' }}</span><span class="summary-value">{{ product.metafields.custom.plantyp | default: 'Avea, Turkcell' }}</span></div>
          <div class="summary-row"><span class="summary-label">{{ 'product.activation' | t | default: 'Activation' }}</span><span class="summary-value">{{ 'product.instant' | t | default: 'Instant' }}</span></div>
          <div class="summary-row"><span class="summary-label">{{ 'product.total' | t | default: 'Total' }}</span><span class="summary-value" id="total-price">-</span></div>
        </div>

        <form action="/cart/add?return_to=/checkout" method="post" id="product-form">
          <input type="hidden" name="id" id="variant-input" value="">
          <button type="submit" class="checkout-button">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:20px;height:20px;">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"/>
            </svg>
            <span>{{ 'product.buy_now' | t | default: 'Buy Now' }}</span>
          </button>
        </form>

        <div class="payment-methods">
          {% assign payment_types = 'visa,master,apple_pay,google_pay,paypal' | split: ',' %}
          {% for type in payment_types %}
            {{ type | payment_type_svg_tag: class: 'payment-method' }}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Sticky Cart -->
  <div class="sticky-cart" id="sticky-cart">
    <div class="sticky-cart-header">
      <div class="sticky-cart-title" id="sticky-title">-</div>
      <div class="sticky-cart-menu">
        <a href="#product-selection" id="sticky-menu-button" aria-label="Open menu">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" width="24" height="24"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>
        </a>
      </div>
    </div>
    <button class="sticky-cart-button" id="sticky-button">{{ 'product.buy_now' | t | default: 'Buy Now' }}</button>
  </div>
</section>

<script>
(function(){
  'use strict';

  const section = document.querySelector('.product-enterprise');
  const variantTabs = section.querySelectorAll('.variant-tab');
  const normalGroup = section.querySelector('#normal-variants');
  const unlimitedGroup = section.querySelector('#unlimited-variants');
  const fairUseNotice = section.querySelector('#fair-use-notice');
  const planCards = section.querySelectorAll('.plan-card');
  const variantInput = section.querySelector('#variant-input');
  const selectedVariantText = section.querySelector('#selected-variant');
  const totalPriceText = section.querySelector('#total-price');
  const productForm = section.querySelector('#product-form');

  const stickyCart = document.querySelector('#sticky-cart');
  const stickyTitle = document.querySelector('#sticky-title');
  const stickyButton = document.querySelector('#sticky-button');
  const stickyMenuButton = document.getElementById('sticky-menu-button');

  const isCustomerLoggedIn = {{ customer.id | default: 'null' }} !== null;
  const freeBlockedServer = {{ free_blocked | json }};
  const loginFreeUrl = {{ login_free_url | json }};

  let currentVariant = null;

  // Device lock for guests (extra hurdle)
  const deviceKey = 'free_0_redeemed_device';
  function getCookie(name){ return (document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)')||0)[2]; }
  function setDeviceLock(){ try{ localStorage.setItem(deviceKey,'true'); }catch(e){} document.cookie="free_0_claimed=1; path=/; max-age=63072000"; }
  let freeBlockedClient = false;
  try { freeBlockedClient = (localStorage.getItem(deviceKey)==='true') || (getCookie('free_0_claimed')==='1'); } catch(e){}

  // Anim in
  if ('IntersectionObserver' in window){
    const io = new IntersectionObserver((es)=>{ es.forEach(e=>{ if(e.isIntersecting){ e.target.classList.add('animate'); io.unobserve(e.target); } }); }, {threshold:0.1});
    planCards.forEach(c=>io.observe(c));
    section.querySelectorAll('.hero-feature, .trust-badge, .purchase-box').forEach(el=>io.observe(el));
  }

  // Tabs
  if (variantTabs.length){
    variantTabs.forEach(tab=>{
      tab.addEventListener('click', function(){
        variantTabs.forEach(t=>t.classList.remove('active'));
        this.classList.add('active');
        const type = this.dataset.tab;
        if (type==='unlimited'){ normalGroup && (normalGroup.style.display='none'); unlimitedGroup && (unlimitedGroup.style.display='block'); fairUseNotice && fairUseNotice.classList.add('active'); }
        else { normalGroup && (normalGroup.style.display='block'); unlimitedGroup && (unlimitedGroup.style.display='none'); fairUseNotice && fairUseNotice.classList.remove('active'); }
        const activeGroup = (type==='unlimited') ? unlimitedGroup : normalGroup;
        const firstCard = activeGroup?.querySelector('.plan-card:not([data-is-free="true"])');
        if (firstCard) selectPlan(firstCard);
      });
    });
  }

  function selectPlan(card){
    const isFree = card.dataset.isFree === 'true';

    if (isFree && freeBlockedServer){
      alert('This free 100MB eSIM has already been claimed on your account.');
      return;
    }
    if (isFree && !isCustomerLoggedIn && freeBlockedClient){
      alert('This free 100MB eSIM has already been claimed on this device.');
      window.location.href = loginFreeUrl;
      return;
    }
    if (isFree && !isCustomerLoggedIn){
      window.location.href = loginFreeUrl;
      return;
    }

    section.querySelectorAll('.plan-card').forEach(c=>c.classList.remove('selected'));
    card.classList.add('selected');

    const radio = card.querySelector('input[type="radio"]');
    if (radio){
      radio.checked = true;
      const title = radio.dataset.title;
      const price = radio.dataset.price;
      variantInput.value = radio.value;
      selectedVariantText.textContent = title;
      totalPriceText.textContent = price;
      if (stickyCart) stickyTitle.textContent = title + ' - ' + price;
      currentVariant = { id: radio.value, isFree, title, price };
    }
  }

  // clicks
  planCards.forEach(card=>{
    card.addEventListener('click', function(e){
      if (e.target.closest('a')) return; // login link inside
      selectPlan(this);
    });
  });

  // submit guard
  productForm.addEventListener('submit', function(e){
    if (!currentVariant){
      e.preventDefault();
      alert('{{ "product.select_variant" | t | default: "Please select a variant" }}');
      return;
    }
    if (currentVariant.isFree){
      if (freeBlockedServer){
        e.preventDefault();
        alert('This free 100MB eSIM has already been claimed on your account.');
        return;
      }
      if (!isCustomerLoggedIn){
        e.preventDefault();
        window.location.href = loginFreeUrl;
        return;
      }
      setDeviceLock();
    }
  });

  // sticky show
  let ticking = false;
  window.addEventListener('scroll', function(){
    if (!ticking && window.innerWidth <= 768){
      window.requestAnimationFrame(function(){
        const selectionTop = section.querySelector('.product-selection')?.offsetTop || 0;
        const scrolled = window.scrollY > (selectionTop - 200);
        stickyCart && stickyCart.classList.toggle('active', scrolled);
        ticking = false;
      });
      ticking = true;
    }
  });

  // sticky buy → real submit
  if (stickyButton){
    stickyButton.addEventListener('click', function(){
      if (!currentVariant){
        const firstNonFree = section.querySelector('.plan-card:not([data-is-free="true"])');
        if (firstNonFree) selectPlan(firstNonFree);
      }
      if (typeof productForm.requestSubmit === 'function') productForm.requestSubmit();
      else productForm.submit();
    });
  }

  // sticky menu → open header mobile menu
  if (stickyMenuButton){
    stickyMenuButton.addEventListener('click', function(e){
      e.preventDefault();
      const headerToggle = document.getElementById('mobile-toggle');
      if (headerToggle) headerToggle.click();
      else {
        const mobileMenu = document.getElementById('mobile-menu');
        const mobileOverlay = document.getElementById('mobile-overlay');
        if (mobileMenu && mobileOverlay){
          mobileMenu.classList.add('active');
          mobileOverlay.classList.add('active');
          document.body.style.overflow = 'hidden';
        }
      }
    });
  }

  // init selection
  const params = new URLSearchParams(location.search);
  const claimFree = params.get('claim') === 'free';
  const firstNonFree = section.querySelector('.plan-card:not([data-is-free="true"])');
  const firstFree = section.querySelector('.plan-card[data-is-free="true"]');
  if (firstNonFree) selectPlan(firstNonFree);
  else if (firstFree && !freeBlockedServer && !( !isCustomerLoggedIn && freeBlockedClient )){
    if (claimFree) selectPlan(firstFree);
  }
})();
</script>

<script>
// Speichert aktuelle Produkt-URL (mit ?claim=free) in Storage + Cookie
function saveReturnUrlClaimFree(){
  var current = location.pathname + location.search;
  var sep = location.search ? '&' : '?';
  var withClaim = current + sep + 'claim=free';
  try {
    sessionStorage.setItem('return_to_product', withClaim);
    localStorage.setItem('return_to_product', withClaim);
  } catch(e){}
  var d = new Date(); d.setTime(d.getTime() + 24*60*60*1000);
  document.cookie = 'return_to_product=' + encodeURIComponent(withClaim) + '; expires=' + d.toUTCString() + '; path=/';
  return withClaim;
}

// Hängt return_to an Login-Links + speichert vorher
(function attachLoginReturn(){
  var links = document.querySelectorAll('.free-login-button, a[href^="/account/login"], a[href^="/customer_authentication/login"]');
  links.forEach(function(a){
    a.addEventListener('click', function(){
      var withClaim = saveReturnUrlClaimFree();
      // Fallback: ?return_to anhängen (hilft, falls App/Shopify es doch übernimmt)
      var encoded = encodeURIComponent(withClaim);
      if (this.href.indexOf('/customer_authentication/login') === 0) {
        this.href = '/customer_authentication/login?return_to=' + encoded;
      } else if (this.href.indexOf('/account/login') === 0) {
        this.href = '/account/login?return_to=' + encoded;
      }
    }, { capture:true, once:false, passive:true });
  });
})();
</script>


{% schema %}
{
  "name": "Product Page",
  "settings": [
    { "type": "header", "content": "Pricing Display" },
    { "type": "checkbox", "id": "show_compare_price", "label": "Show Compare at Price", "default": false, "info": "Display crossed-out old price" },
    { "type": "range", "id": "price_increase_percent", "label": "Price Increase Percentage", "min": 0, "max": 100, "step": 5, "default": 0, "unit": "%", "info": "Show old price as X% higher than current (only if compare price not set)" }
  ],
  "presets": [{ "name": "Product Page" }]
}
{% endschema %}
